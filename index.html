<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üìö LibraLens</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap');

:root {
‚Äìink: #1a1208;
‚Äìpaper: #f5ede0;
‚Äìamber: #d4820a;
‚Äìgold: #f0b429;
‚Äìfound: #2dba6f;
}

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
font-family: ‚ÄòDM Sans‚Äô, sans-serif;
background: var(‚Äìink);
color: var(‚Äìpaper);
height: 100dvh;
display: flex;
flex-direction: column;
overflow: hidden;
}

header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 16px 20px 12px;
flex-shrink: 0;
}

.logo {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 24px;
font-weight: 900;
color: var(‚Äìgold);
}
.logo span { color: var(‚Äìpaper); font-weight: 400; }

.status-pill {
background: rgba(245,237,224,0.1);
border-radius: 20px;
padding: 5px 12px;
font-size: 12px;
color: rgba(245,237,224,0.6);
transition: all 0.3s;
}
.status-pill.ready { background: rgba(45,186,111,0.2); color: var(‚Äìfound); }
.status-pill.scanning { background: rgba(240,180,41,0.2); color: var(‚Äìgold); }
.status-pill.error { background: rgba(192,57,43,0.2); color: #e74c3c; }

.search-area {
padding: 0 20px 14px;
flex-shrink: 0;
}

.search-label {
font-size: 11px;
font-weight: 500;
text-transform: uppercase;
letter-spacing: 1.5px;
color: var(‚Äìamber);
margin-bottom: 8px;
}

.search-row { display: flex; gap: 10px; }

.search-input {
flex: 1;
background: rgba(245,237,224,0.1);
border: 1.5px solid rgba(245,237,224,0.2);
border-radius: 12px;
padding: 13px 16px;
color: var(‚Äìpaper);
font-family: ‚ÄòDM Sans‚Äô, sans-serif;
font-size: 16px;
outline: none;
-webkit-appearance: none;
transition: border-color 0.2s;
}
.search-input::placeholder { color: rgba(245,237,224,0.35); }
.search-input:focus { border-color: var(‚Äìgold); }

.scan-btn {
background: var(‚Äìamber);
color: var(‚Äìink);
border: none;
border-radius: 12px;
padding: 13px 18px;
font-family: ‚ÄòDM Sans‚Äô, sans-serif;
font-size: 14px;
font-weight: 700;
cursor: pointer;
white-space: nowrap;
-webkit-tap-highlight-color: transparent;
transition: background 0.2s, transform 0.1s;
}
.scan-btn:active { transform: scale(0.96); }
.scan-btn.scanning { background: #c0392b; color: white; }

.camera-wrapper {
flex: 1;
position: relative;
overflow: hidden;
background: #000;
}

video {
width: 100%; height: 100%;
object-fit: cover;
display: block;
}

canvas#overlay {
position: absolute;
top: 0; left: 0;
width: 100%; height: 100%;
pointer-events: none;
}

/* Hidden canvas for processing */
canvas#capture { display: none; }

.start-screen {
position: absolute;
inset: 0;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
background: linear-gradient(145deg, #1a1208, #2d1f0a);
gap: 20px;
z-index: 5;
}
.book-icon { font-size: 64px; animation: float 3s ease-in-out infinite; }
@keyframes float {
0%,100% { transform: translateY(0); }
50% { transform: translateY(-10px); }
}
.start-title {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 28px; font-weight: 700;
text-align: center; line-height: 1.2;
}
.start-sub {
font-size: 14px;
color: rgba(245,237,224,0.55);
text-align: center;
max-width: 260px;
line-height: 1.6;
}
.start-btn {
background: var(‚Äìgold);
color: var(‚Äìink);
border: none;
border-radius: 50px;
padding: 16px 36px;
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 17px; font-weight: 700;
cursor: pointer;
box-shadow: 0 8px 24px rgba(240,180,41,0.35);
-webkit-tap-highlight-color: transparent;
}

.scan-line {
position: absolute;
left: 0; right: 0; height: 2px;
background: linear-gradient(90deg, transparent, var(‚Äìgold), transparent);
animation: scanDown 2s linear infinite;
display: none; z-index: 4;
}
.scan-line.active { display: block; }
@keyframes scanDown {
0% { top: 0%; } 100% { top: 100%; }
}

.result-banner {
position: absolute;
bottom: 0; left: 0; right: 0;
padding: 16px 20px 32px;
background: linear-gradient(0deg, rgba(26,18,8,0.97) 0%, transparent 100%);
z-index: 10;
display: none;
}

.result-status {
font-size: 11px; font-weight: 600;
text-transform: uppercase; letter-spacing: 1.5px;
margin-bottom: 5px;
}
.result-status.found { color: var(‚Äìfound); }
.result-status.searching { color: var(‚Äìgold); }
.result-status.idle { color: rgba(245,237,224,0.4); }

.result-text {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
font-size: 20px; font-weight: 700;
line-height: 1.3;
}
.result-sub {
font-size: 13px;
color: rgba(245,237,224,0.5);
margin-top: 4px;
}

/* Not supported message */
.not-supported {
position: fixed;
inset: 0;
background: var(‚Äìink);
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 30px;
gap: 16px;
z-index: 100;
text-align: center;
}
.not-supported.visible { display: flex; }
.not-supported h2 {
font-family: ‚ÄòPlayfair Display‚Äô, serif;
color: var(‚Äìgold);
font-size: 22px;
}
.not-supported p {
color: rgba(245,237,224,0.6);
font-size: 14px;
line-height: 1.7;
max-width: 300px;
}
.not-supported code {
background: rgba(245,237,224,0.1);
padding: 2px 8px;
border-radius: 6px;
font-size: 13px;
color: var(‚Äìgold);
}
</style>

</head>
<body>

<!-- Not supported screen -->

<div class="not-supported" id="notSupported">
  <div style="font-size:48px">‚ö†Ô∏è</div>
  <h2>Shape Detection non activ√©</h2>
  <p>Pour utiliser LibraLens, active l'option dans :<br><br>
  <strong>R√©glages ‚Üí Safari ‚Üí Avanc√©<br>‚Üí Experimental Features<br>‚Üí <code>Shape Detection API</code></strong><br><br>
  Puis recharge cette page.</p>
</div>

<header>
  <div class="logo">Libra<span>Lens</span></div>
  <div class="status-pill" id="statusPill">V√©rification...</div>
</header>

<div class="search-area">
  <div class="search-label">Quel livre cherches-tu ?</div>
  <div class="search-row">
    <input class="search-input" id="bookInput" type="text"
      placeholder="Ex: Le Petit Prince..."
      autocomplete="off" autocorrect="off" spellcheck="false">
    <button class="scan-btn" id="scanBtn" onclick="toggleScan()">üîç Scanner</button>
  </div>
</div>

<div class="camera-wrapper">
  <div class="start-screen" id="startScreen">
    <div class="book-icon">üìö</div>
    <div class="start-title">Trouve ton livre<br>en un regard</div>
    <div class="start-sub">OCR natif Apple ‚Äî rapide, gratuit, sans connexion requise.</div>
    <button class="start-btn" onclick="startCamera()">Activer la cam√©ra</button>
  </div>

<video id="video" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>
<canvas id="capture"></canvas>

  <div class="scan-line" id="scanLine"></div>

  <div class="result-banner" id="resultBanner">
    <div class="result-status idle" id="resultStatus">En attente</div>
    <div class="result-text" id="resultText"></div>
    <div class="result-sub" id="resultSub"></div>
  </div>
</div>

<script>
  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const capture = document.getElementById('capture');
  const ctx = overlay.getContext('2d');
  const capCtx = capture.getContext('2d');
  const statusPill = document.getElementById('statusPill');

  let stream = null;
  let scanning = false;
  let scanInterval = null;
  let isProcessing = false;
  let detector = null;

  // Check Shape Detection API support
  function checkSupport() {
    if (!('TextDetector' in window)) {
      document.getElementById('notSupported').classList.add('visible');
      statusPill.textContent = 'Non support√©';
      statusPill.className = 'status-pill error';
      return false;
    }
    try {
      detector = new TextDetector();
      statusPill.textContent = '‚úì Pr√™t';
      statusPill.className = 'status-pill ready';
      return true;
    } catch(e) {
      document.getElementById('notSupported').classList.add('visible');
      statusPill.textContent = 'Erreur';
      statusPill.className = 'status-pill error';
      return false;
    }
  }

  checkSupport();

  async function startCamera() {
    if (!detector) { checkSupport(); return; }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      });
      video.srcObject = stream;
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('resultBanner').style.display = 'block';

      video.addEventListener('loadedmetadata', () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        capture.width = video.videoWidth;
        capture.height = video.videoHeight;
      });
    } catch(e) {
      alert('Impossible d\'acc√©der √† la cam√©ra.\n' + e.message);
    }
  }

  function toggleScan() {
    if (!stream) { alert('Active d\'abord la cam√©ra !'); return; }
    if (!detector) { checkSupport(); return; }

    const title = document.getElementById('bookInput').value.trim();
    if (!title) {
      document.getElementById('bookInput').focus();
      document.getElementById('bookInput').style.borderColor = 'var(--gold)';
      setTimeout(() => document.getElementById('bookInput').style.borderColor = '', 1500);
      return;
    }

    scanning ? stopScan() : startScan(title);
  }

  function startScan(title) {
    scanning = true;
    const btn = document.getElementById('scanBtn');
    btn.textContent = '‚èπ Arr√™ter';
    btn.classList.add('scanning');
    document.getElementById('scanLine').classList.add('active');
    statusPill.textContent = 'Scan en cours...';
    statusPill.className = 'status-pill scanning';

    document.getElementById('resultStatus').textContent = 'Analyse en cours...';
    document.getElementById('resultStatus').className = 'result-status searching';
    document.getElementById('resultText').textContent = `Cherche : "${title}"`;
    document.getElementById('resultSub').textContent = 'Pointe vers l\'√©tag√®re...';

    doScan(title);
    scanInterval = setInterval(() => doScan(title), 2000);
  }

  function stopScan() {
    scanning = false;
    clearInterval(scanInterval);
    isProcessing = false;
    const btn = document.getElementById('scanBtn');
    btn.textContent = 'üîç Scanner';
    btn.classList.remove('scanning');
    document.getElementById('scanLine').classList.remove('active');
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    statusPill.textContent = '‚úì Pr√™t';
    statusPill.className = 'status-pill ready';
    document.getElementById('resultStatus').textContent = 'Scan arr√™t√©';
    document.getElementById('resultStatus').className = 'result-status idle';
    document.getElementById('resultText').textContent = '';
    document.getElementById('resultSub').textContent = '';
  }

  async function doScan(searchTitle) {
    if (!scanning || isProcessing) return;
    isProcessing = true;

    try {
      // Draw current video frame to capture canvas
      capCtx.drawImage(video, 0, 0, capture.width, capture.height);

      // Use native TextDetector
      const results = await detector.detect(capture);

      if (!scanning) { isProcessing = false; return; }

      ctx.clearRect(0, 0, overlay.width, overlay.height);

      if (!results || results.length === 0) {
        document.getElementById('resultSub').textContent = 'Aucun texte d√©tect√© ‚Äî rapproche-toi ou am√©liore l\'√©clairage';
        isProcessing = false;
        return;
      }

      // Combine all detected text
      const allText = results.map(r => r.rawValue).join(' ');
      console.log('Texte d√©tect√©:', allText);

      const { found, matchedBlock } = fuzzyMatch(searchTitle, results);

      if (found && matchedBlock) {
        // Draw highlight around found text
        drawHighlight(matchedBlock.boundingBox, matchedBlock.rawValue);

        document.getElementById('resultStatus').textContent = '‚úÖ LIVRE TROUV√â !';
        document.getElementById('resultStatus').className = 'result-status found';
        document.getElementById('resultText').textContent = matchedBlock.rawValue;
        document.getElementById('resultSub').textContent = 'Encadr√© en vert sur l\'image';
        statusPill.textContent = '‚úì Trouv√© !';
        statusPill.className = 'status-pill ready';

        if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 300]);

      } else {
        const count = results.length;
        document.getElementById('resultStatus').textContent = 'üîç Pas encore trouv√©';
        document.getElementById('resultStatus').className = 'result-status searching';
        document.getElementById('resultText').textContent = `"${searchTitle}"`;
        document.getElementById('resultSub').textContent = `${count} bloc(s) de texte lus ‚Äî continue √† filmer`;
      }

    } catch(e) {
      document.getElementById('resultSub').textContent = '‚ùå ' + e.message;
      console.error(e);
    }

    isProcessing = false;
  }

  function fuzzyMatch(search, detectedBlocks) {
    const normalize = s => s.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9\s]/g, ' ')
      .replace(/\s+/g, ' ').trim();

    const normSearch = normalize(search);
    const searchWords = normSearch.split(' ').filter(w => w.length > 2);
    if (!searchWords.length) return { found: false };

    let bestBlock = null;
    let bestScore = 0;

    for (const block of detectedBlocks) {
      const normBlock = normalize(block.rawValue);
      const matchCount = searchWords.filter(w => normBlock.includes(w)).length;
      const ratio = matchCount / searchWords.length;
      if (ratio > bestScore) {
        bestScore = ratio;
        bestBlock = block;
      }
    }

    // 60% of words must match
    if (bestScore >= 0.6) {
      return { found: true, matchedBlock: bestBlock };
    }
    return { found: false };
  }

  function drawHighlight(bbox, label) {
    const scaleX = overlay.width / capture.width;
    const scaleY = overlay.height / capture.height;

    const x = bbox.x * scaleX;
    const y = bbox.y * scaleY;
    const w = bbox.width * scaleX;
    const h = bbox.height * scaleY;
    const pad = 16;

    ctx.save();
    ctx.shadowColor = '#2dba6f';
    ctx.shadowBlur = 25;

    // Fill
    ctx.fillStyle = 'rgba(45, 186, 111, 0.25)';
    ctx.fillRect(x - pad, y - pad, w + pad*2, h + pad*2);

    // Border
    ctx.strokeStyle = '#2dba6f';
    ctx.lineWidth = 3;
    ctx.strokeRect(x - pad, y - pad, w + pad*2, h + pad*2);
    ctx.restore();

    // Label tag
    ctx.fillStyle = '#2dba6f';
    ctx.font = 'bold 16px sans-serif';
    ctx.fillText('‚úì Trouv√© !', x - pad + 6, y - pad - 8);

    // Corner brackets on full screen
    drawCorners();
  }

  function drawCorners() {
    const W = overlay.width, H = overlay.height;
    const s = 45, p = 20;
    ctx.save();
    ctx.strokeStyle = '#2dba6f';
    ctx.lineWidth = 4;
    ctx.shadowColor = '#2dba6f';
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.moveTo(p, p+s); ctx.lineTo(p, p); ctx.lineTo(p+s, p);
    ctx.moveTo(W-p-s, p); ctx.lineTo(W-p, p); ctx.lineTo(W-p, p+s);
    ctx.moveTo(p, H-p-s); ctx.lineTo(p, H-p); ctx.lineTo(p+s, H-p);
    ctx.moveTo(W-p-s, H-p); ctx.lineTo(W-p, H-p); ctx.lineTo(W-p, H-p-s);
    ctx.stroke();
    ctx.restore();
  }
</script>

</body>
</html>
